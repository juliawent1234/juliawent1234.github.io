<script>
  const board = document.getElementById('board');
  const cells = [];

  function moveNext(r, c) {
    let nr = r;
    let nc = c + 1;
    if (nc > 8) {
      nc = 0;
      nr++;
    }
    if (nr < 9) cells[nr][nc].focus();
  }

  function movePrev(r, c) {
    let pr = r;
    let pc = c - 1;
    if (pc < 0) {
      pc = 8;
      pr--;
    }
    if (pr >= 0) cells[pr][pc].focus();
  }

  function moveByArrow(r, c, key) {
    let nr = r;
    let nc = c;

    if (key === 'ArrowUp') nr--;
    if (key === 'ArrowDown') nr++;
    if (key === 'ArrowLeft') nc--;
    if (key === 'ArrowRight') nc++;

    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) {
      cells[nr][nc].focus();
    }
  }

  for (let r = 0; r < 9; r++) {
    cells[r] = [];
    for (let c = 0; c < 9; c++) {
      const input = document.createElement('input');
      input.className = 'cell';
      input.maxLength = 1;
      input.inputMode = 'numeric';

      if (c === 2 || c === 5) input.classList.add('b-right');
      if (r === 2 || r === 5) input.classList.add('b-bottom');

      // 输入 1-9 自动跳格
      input.addEventListener('input', () => {
        if (!/^[1-9]$/.test(input.value)) {
          input.value = '';
          return;
        }
        moveNext(r, c);
      });

      input.addEventListener('keydown', (e) => {
        // Space 跳过
        if (e.code === 'Space') {
          input.value = '';
          moveNext(r, c);
          e.preventDefault();
          return;
        }

        // Backspace 行为
        if (e.key === 'Backspace') {
          if (input.value !== '') {
            input.value = '';
          } else {
            movePrev(r, c);
            let pr = r;
            let pc = c - 1;
            if (pc < 0) {
              pc = 8;
              pr--;
            }
            if (pr >= 0) cells[pr][pc].value = '';
          }
          e.preventDefault();
          return;
        }

        // 方向键移动
        if (
          e.key === 'ArrowUp' ||
          e.key === 'ArrowDown' ||
          e.key === 'ArrowLeft' ||
          e.key === 'ArrowRight'
        ) {
          moveByArrow(r, c, e.key);
          e.preventDefault();
        }
      });

      board.appendChild(input);
      cells[r][c] = input;
    }
  }

  function getGrid() {
    return cells.map(row => row.map(c => parseInt(c.value) || 0));
  }

  function setGrid(grid) {
    for (let r = 0; r < 9; r++) {
      for (let c = 0; c < 9; c++) {
        if (!cells[r][c].value) {
          cells[r][c].value = grid[r][c];
          cells[r][c].style.background = 'var(--solved)';
        }
      }
    }
  }

  function valid(grid, r, c, v) {
    for (let i = 0; i < 9; i++)
      if (grid[r][i] === v || grid[i][c] === v) return false;

    const br = Math.floor(r / 3) * 3;
    const bc = Math.floor(c / 3) * 3;
    for (let i = br; i < br + 3; i++)
      for (let j = bc; j < bc + 3; j++)
        if (grid[i][j] === v) return false;

    return true;
  }

  function solveGrid(grid) {
    for (let r = 0; r < 9; r++) {
      for (let c = 0; c < 9; c++) {
        if (grid[r][c] === 0) {
          for (let n = 1; n <= 9; n++) {
            if (valid(grid, r, c, n)) {
              grid[r][c] = n;
              if (solveGrid(grid)) return true;
              grid[r][c] = 0;
            }
          }
          return false;
        }
      }
    }
    return true;
  }

  function solve() {
    const grid = getGrid();
    if (solveGrid(grid)) setGrid(grid);
    else alert('该题无解');
  }

  function clearBoard() {
    for (let r = 0; r < 9; r++) {
      for (let c = 0; c < 9; c++) {
        cells[r][c].value = '';
        cells[r][c].style.background = 'var(--cell-bg)';
      }
    }
  }
</script>
